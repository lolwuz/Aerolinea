<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <title>Aerol√≠nea</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div id="infoCard" class="card">
        <img id="AirportImg" class="card-img-top" src="..." alt="Card image cap">
        <div class="card-body">
            <h4 id="Airport">Airport Name</h4>
            <p id="AirportInfo" class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
            <a href="#" class="btn btn-primary">Buy landing rights</a>
        </div>
    </div>

    <div id="routeCard" class="card">
        <ul id="routeList" class="list-group list-group-flush">
        </ul>
        <div class="card-body">
            <a id="newRouteButton" href="#" class="btn btn-primary" onclick="newroute()">New route</a>
        </div>
    </div>
 

    <canvas id="gameCanvas"></canvas>

    <script src="javascript/three.js"></script>
    <script src="javascript/controls/OrbitControls.js"></script>
    <script src="javascript/OBJLoader.js"></script>
    <script src="objects/Scene.js"></script>
    <script src="objects/World.js"></script>
    <script src="objects/Airport.js"></script>
    <script src="objects/Airplane.js"></script>
    <script src="objects/Route.js"></script>
    <script src="objects/RouteLine.js"></script>
    <script src="objects/Clouds.js"></script>
    <script>

        var scene;
        var raycaster = new THREE.Raycaster();
        var mouse = new THREE.Vector2();
        const clock = new THREE.Clock();

        var isNewRoute = false;
        var newRoute = []; 

        

        init();
        animate();

        function init() {
            scene = new Scene();
            window.addEventListener('resize', onWindowResize, false);
            window.addEventListener( 'click', onMouseClick, false );

            for (let i=0; i< scene.children[0].children.length; i++) {
                if(scene.children[0].children[i].constructor.name === "Airport"){
                    // document.getElementById("AirportList").innerHTML += "<a href=\"#\" class=\"list-group-item list-group-item-action\">" + scene.children[0].children[i].info.name + "</a>";
                }
            }
        }

        function animate() {
            
            let delta = clock.getDelta();

            requestAnimationFrame(animate);
            scene.update(delta);

        }

        function onWindowResize() {

            scene.camera.aspect = window.innerWidth / window.innerHeight;
            scene.camera.updateProjectionMatrix();
            scene.renderer.setSize(window.innerWidth, window.innerHeight);

        }

        function onMouseClick( event ) {
            // calculate mouse position in normalized device coordinates
            // (-1 to +1) for both components
            mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
            mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

            // update the picking ray with the camera and mouse position
            raycaster.setFromCamera( mouse.clone(), scene.camera );

            // calculate objects intersecting the picking ray
            let intersects = raycaster.intersectObjects( scene.children[0].children );
            
            for ( let i = 0; i < intersects.length; i++ ) {
                if(intersects[i].object.constructor.name === "Airport"){
                    if(isNewRoute){
                        newRoute.push(intersects[i].object.info._id);
                        document.getElementById("routeList").innerHTML = "";

                        for(let i = 0; i < newRoute.length; i++){
                            document.getElementById("routeList").innerHTML += "<li class='list-group-item'>" + newRoute[i] + "</li>"
                        }
                    }
                    console.log(intersects[i].object.info.name);
                    document.getElementById("Airport").innerText = intersects[i].object.info.name;
                    document.getElementById("AirportInfo").innerText = intersects[i].object.info;
                    document.getElementById("AirportImg").src="https://maps.googleapis.com/maps/api/staticmap?center="+ intersects[i].object.info.lat + "," + intersects[i].object.info.lon + "&zoom=8&size=400x250&key=AIzaSyCaqRZpDr07TXFnlyLr6ZOKJYCwwpBTbW0";

                }
            }
        }

        function newroute(){
            isNewRoute = true;

            document.getElementById("newRouteButton").innerText = "Add route";
            document.getElementById("newRouteButton").onclick = addroute;
            
        }

        async function addroute(){
    
            console.log("add route");
            document.getElementById("newRouteButton").innerText = "New route";
            document.getElementById("newRouteButton").onclick = newroute;

            let destinations = new Object();

            for(let i = 0; i < newRoute.length; i++){
                destinations['destinations[' + i + ']'] = newRoute[i];
            }

            let formBody = [];
            for (var property in destinations) {
              var encodedKey = encodeURIComponent(property);
              var encodedValue = encodeURIComponent(destinations[property]);
              formBody.push(encodedKey + "=" + encodedValue);
            }
            formBody = formBody.join("&");

            console.log(formBody);
            console.log(getCookie("token"));
        
            let id = "59e9f093a8c44e1774b155a5";
            let response = await fetch('http://server.lolwuz.com:3000/airliner/' + id + '/route', {
                method: 'POST',
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "Authorization": "JWT " + getCookie("token")
                },
                body: formBody
            });
            
            let data = await response;
            console.log(data);

            isNewRoute = false;
            newRoute = []; 
        }

        function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for(var i = 0; i <ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
        }

    </script>
</body>
</html>
